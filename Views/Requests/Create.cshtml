@model CreateRequestViewModel
@{
    ViewData["Title"] = "בקשה חדשה";
    var employees = ViewBag.Employees as List<Employee>;
    var systems = ViewBag.Systems as List<ApplicationSystem>;
    var managers = ViewBag.Managers as List<ApplicationUser>;
}

<h2><i class="bi bi-plus-circle"></i> בקשה חדשה</h2>
<hr />

<form asp-action="Create" method="post" id="requestForm">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label asp-for="ServiceLevel" class="form-label"></label>
                <select asp-for="ServiceLevel" class="form-select" id="serviceLevel">
                    <option value="">בחר רמת שירות</option>
                    <option value="1">רמת משתמש</option>
                    <option value="2">רמת משתמש אחר</option>
                    <option value="3">ריבוי משתמשים</option>
                </select>
                <span asp-validation-for="ServiceLevel" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="form-group mb-3">
                <label class="form-label">בחר עובדים</label>
                <div class="card">
                    <div class="card-body">
                        <div class="mb-2">
                            <input type="text" id="employeeSearch" class="form-control" placeholder="חפש עובד..." />
                        </div>
                        <div class="employee-list" style="max-height: 200px; overflow-y: auto;">
                            @if (employees != null)
                            {
                                @foreach (var employee in employees)
                                {
                                    <div class="form-check employee-item" data-name="@($"{employee.FirstName} {employee.LastName}")">
                                        <input class="form-check-input" type="checkbox" name="SelectedEmployeeIds" value="@employee.Id" id="emp_@employee.Id" />
                                        <label class="form-check-label" for="emp_@employee.Id">
                                            @employee.FirstName @employee.LastName - @employee.Department (@employee.EmployeeId)
                                        </label>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
                <span asp-validation-for="SelectedEmployeeIds" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="form-group mb-3">
                <label class="form-label">בחר מערכות</label>
                <div class="card">
                    <div class="card-body">
                        @if (systems != null)
                        {
                            @foreach (var system in systems)
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="SelectedSystemIds" value="@system.Id" id="sys_@system.Id" />
                                    <label class="form-check-label" for="sys_@system.Id">
                                        <strong>@system.Name</strong>
                                        @if (!string.IsNullOrEmpty(system.Description))
                                        {
                                            <small class="text-muted"> - @system.Description</small>
                                        }
                                        @if (!string.IsNullOrEmpty(system.Category))
                                        {
                                            <span class="badge bg-secondary">@system.Category</span>
                                        }
                                    </label>
                                </div>
                            }
                        }
                    </div>
                </div>
                <span asp-validation-for="SelectedSystemIds" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="form-group mb-3">
                <label asp-for="Comments" class="form-label"></label>
                <textarea asp-for="Comments" class="form-control" rows="4" placeholder="הכנס הערות..."></textarea>
                <span asp-validation-for="Comments" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label asp-for="ManagerId" class="form-label">
                    <strong>מנהל אחראי</strong> <span class="text-danger">*</span>
                </label>
                <div class="search-wrapper position-relative">
                    <i class="bi bi-search position-absolute" style="right: 15px; top: 50%; transform: translateY(-50%); color: #6c757d; z-index: 10;"></i>
                    <input type="text" id="managerSearch" class="form-control" placeholder="חפש מנהל (התחל להקליד שם)..." autocomplete="off" />
                    <div class="autocomplete-dropdown" style="display: none;"></div>
                </div>
                <select asp-for="ManagerId" class="form-select mt-2" id="managerSelect" required>
                    <option value="">-- בחר מנהל אחראי --</option>
                    @if (managers != null)
                    {
                        @foreach (var manager in managers)
                        {
                            <option value="@manager.Id" data-name="@manager.FullName" data-username="@manager.UserName">@manager.FullName - @manager.Email</option>
                        }
                    }
                </select>
                <input type="hidden" id="selectedManagerId" name="ManagerId" />
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> החיפוש מחפש במסד הנתונים המקומי ובמידת הצורך גם ב-Active Directory. לחץ על משתמש מהרשימה כדי לבחור.
                    </small>
                </div>
                <span asp-validation-for="ManagerId" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="form-check mb-3">
                <input asp-for="DisclosureAcknowledged" class="form-check-input" type="checkbox" id="disclosureCheck" />
                <label asp-for="DisclosureAcknowledged" class="form-check-label" for="disclosureCheck">
                    אני מאשר כי קראתי והבנתי את תנאי השימוש ומאשר את בקשת ההרשאה
                </label>
                <span asp-validation-for="DisclosureAcknowledged" class="text-danger d-block"></span>
            </div>
        </div>
    </div>

    <div class="form-group">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> שלח בקשה
        </button>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> ביטול
        </a>
    </div>
</form>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            // Employee search
            $('#employeeSearch').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('.employee-item').filter(function() {
                    $(this).toggle($(this).data('name').toLowerCase().indexOf(value) > -1);
                });
            });

            // Manager search with Active Directory auto-complete (works offline - local DB first)
            let searchTimeout;
            let currentResults = [];
            let dropdown = $('.autocomplete-dropdown');

            $('#managerSearch').on('input', function() {
                clearTimeout(searchTimeout);
                var value = $(this).val().trim();

                if (value.length < 2) {
                    dropdown.hide();
                    currentResults = [];
                    return;
                }

                // Debounce search
                searchTimeout = setTimeout(function() {
                    searchUsers(value);
                }, 300);
            });

            function searchUsers(term) {
                var input = $('#managerSearch');
                if (dropdown.length === 0) {
                    input.parent().append('<div class="autocomplete-dropdown"></div>');
                    dropdown = $('.autocomplete-dropdown');
                }

                // Show loading
                dropdown.html('<div class="autocomplete-item text-center p-3"><div class="spinner-border spinner-border-sm" role="status"></div> טוען...</div>').show();

                console.log('Searching users for term:', term);

                $.ajax({
                    url: '/Requests/SearchAdUsers',
                    method: 'GET',
                    data: { term: term, maxResults: 15 },
                    timeout: 10000,
                    success: function(users) {
                        console.log('Search results:', users);
                        
                        if (users && Array.isArray(users)) {
                            currentResults = users.filter(function(u) {
                                return u && !u.error && u.username;
                            });
                        } else {
                            currentResults = [];
                        }
                        
                        renderAutocomplete(currentResults);
                    },
                    error: function(xhr, status, error) {
                        console.error('Search error:', status, error, xhr);
                        var errorMsg = 'שגיאה בחיפוש משתמשים';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        dropdown.html('<div class="autocomplete-item text-danger"><i class="bi bi-exclamation-triangle"></i> ' + errorMsg + '</div>');
                    }
                });
            }

            function renderAutocomplete(users) {
                var dropdown = $('.autocomplete-dropdown');
                
                if (users.length === 0) {
                    dropdown.html('<div class="autocomplete-item text-muted"><i class="bi bi-info-circle"></i> לא נמצאו תוצאות</div>').show();
                    return;
                }
                
                var html = users.map(function(user, index) {
                    var isLocal = user.isLocal === true;
                    var badge = isLocal ? '<span class="badge bg-success ms-2">מקומי</span>' : '<span class="badge bg-primary ms-2">AD</span>';
                    return `<div class="autocomplete-item" data-index="${index}" data-username="${user.username}" data-user-id="${user.userId || ''}" data-is-local="${isLocal}">
                        <strong>${user.fullName}</strong> ${badge}
                        ${user.email ? '<br><small class="text-muted"><i class="bi bi-envelope"></i> ' + user.email + '</small>' : ''}
                        ${user.department ? '<br><small class="text-muted"><i class="bi bi-building"></i> ' + user.department + '</small>' : ''}
                    </div>`;
                }).join('');
                
                dropdown.html(html).show();
            }

            // Handle autocomplete selection
            $(document).on('click', '.autocomplete-item', function(e) {
                e.stopPropagation();
                var index = $(this).data('index');
                var user = currentResults[index];
                
                if (user && !$(this).hasClass('text-danger') && !$(this).hasClass('text-muted')) {
                    $('#managerSearch').val(user.fullName + (user.email ? ' - ' + user.email : ''));
                    $('.autocomplete-dropdown').hide();
                    
                    var select = $('#managerSelect');
                    
                    // If user has userId (from local DB), use it directly
                    if (user.userId && user.isLocal) {
                        var option = select.find(`option[value="${user.userId}"]`);
                        if (option.length > 0) {
                            select.val(user.userId);
                            select.show();
                            $('.import-user-message').remove();
                            return;
                        }
                    }
                    
                    // Try to find by username
                    var option = select.find(`option[data-username="${user.username}"]`);
                    
                    if (option.length > 0) {
                        select.val(option.val());
                        select.show();
                        $('.import-user-message').remove();
                    } else {
                        // Add user to dropdown
                        var valueToUse = user.userId || user.username;
                        var newOption = $('<option></option>')
                            .attr('value', valueToUse)
                            .attr('data-username', user.username)
                            .attr('data-temp', user.isLocal ? 'false' : 'true')
                            .text(user.fullName + (user.email ? ' - ' + user.email : ''));
                        
                        select.append(newOption);
                        select.val(valueToUse);
                        select.show();
                        
                        if (!user.isLocal) {
                            $('.import-user-message').remove();
                            select.after('<div class="alert alert-info import-user-message mt-2"><i class="bi bi-info-circle"></i> משתמש זה מ-Active Directory. אם הוא לא במערכת, הוא יתווסף בעת שליחת הבקשה.</div>');
                        } else {
                            $('.import-user-message').remove();
                        }
                    }
                }
            });

            // Hide dropdown when clicking outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('#managerSearch, .autocomplete-dropdown').length) {
                    $('.autocomplete-dropdown').hide();
                }
            });

            // Sync managerSearch with ManagerId when user selects from dropdown
            $('#managerSelect').on('change', function() {
                var selectedOption = $(this).find('option:selected');
                if (selectedOption.val() && selectedOption.val() !== '') {
                    var displayText = selectedOption.text();
                    $('#managerSearch').val(displayText);
                }
            });

            // Form validation
            $('#requestForm').on('submit', function(e) {
                var hasEmployees = $('input[name="SelectedEmployeeIds"]:checked').length > 0;
                var hasSystems = $('input[name="SelectedSystemIds"]:checked').length > 0;
                var hasManager = $('#managerSelect').val() !== '';
                var hasDisclosure = $('#disclosureCheck').is(':checked');

                if (!hasEmployees) {
                    alert('אנא בחר לפחות עובד אחד');
                    e.preventDefault();
                    return false;
                }

                if (!hasSystems) {
                    alert('אנא בחר לפחות מערכת אחת');
                    e.preventDefault();
                    return false;
                }

                if (!hasManager) {
                    alert('אנא בחר מנהל אחראי');
                    e.preventDefault();
                    return false;
                }

                if (!hasDisclosure) {
                    alert('אנא אשר את גילוי הנאות');
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}

