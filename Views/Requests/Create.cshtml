@model CreateRequestViewModel
@{
    ViewData["Title"] = "בקשה חדשה";
    var employees = ViewBag.Employees as List<Employee>;
    var systems = ViewBag.Systems as List<ApplicationSystem>;
    var managers = ViewBag.Managers as List<ApplicationUser>;
}

<h2><i class="bi bi-plus-circle"></i> בקשה חדשה</h2>
<hr />

<form asp-action="Create" method="post" id="requestForm">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label asp-for="ServiceLevel" class="form-label"></label>
                <select asp-for="ServiceLevel" class="form-select" id="serviceLevel">
                    <option value="">בחר רמת שירות</option>
                    <option value="1">רמת משתמש</option>
                    <option value="2">רמת משתמש אחר</option>
                    <option value="3">ריבוי משתמשים</option>
                </select>
                <span asp-validation-for="ServiceLevel" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="form-group mb-3">
                <label class="form-label">בחר עובדים</label>
                <div class="card">
                    <div class="card-body">
                        <div class="mb-2">
                            <input type="text" id="employeeSearch" class="form-control" placeholder="חפש עובד..." />
                        </div>
                        <div class="employee-list" style="max-height: 200px; overflow-y: auto;">
                            @if (employees != null)
                            {
                                @foreach (var employee in employees)
                                {
                                    <div class="form-check employee-item" data-name="@($"{employee.FirstName} {employee.LastName}")">
                                        <input class="form-check-input" type="checkbox" name="SelectedEmployeeIds" value="@employee.Id" id="emp_@employee.Id" />
                                        <label class="form-check-label" for="emp_@employee.Id">
                                            @employee.FirstName @employee.LastName - @employee.Department (@employee.EmployeeId)
                                        </label>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
                <span asp-validation-for="SelectedEmployeeIds" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="form-group mb-3">
                <label class="form-label">בחר מערכות</label>
                <div class="card">
                    <div class="card-body">
                        @if (systems != null)
                        {
                            @foreach (var system in systems)
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="SelectedSystemIds" value="@system.Id" id="sys_@system.Id" />
                                    <label class="form-check-label" for="sys_@system.Id">
                                        <strong>@system.Name</strong>
                                        @if (!string.IsNullOrEmpty(system.Description))
                                        {
                                            <small class="text-muted"> - @system.Description</small>
                                        }
                                        @if (!string.IsNullOrEmpty(system.Category))
                                        {
                                            <span class="badge bg-secondary">@system.Category</span>
                                        }
                                    </label>
                                </div>
                            }
                        }
                    </div>
                </div>
                <span asp-validation-for="SelectedSystemIds" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="form-group mb-3">
                <label asp-for="Comments" class="form-label"></label>
                <textarea asp-for="Comments" class="form-control" rows="4" placeholder="הכנס הערות..."></textarea>
                <span asp-validation-for="Comments" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label asp-for="ManagerId" class="form-label"></label>
                <div class="mb-2">
                    <input type="text" id="managerSearch" class="form-control" placeholder="חפש מנהל..." />
                </div>
                <select asp-for="ManagerId" class="form-select" id="managerSelect">
                    <option value="">בחר מנהל אחראי</option>
                    @if (managers != null)
                    {
                        @foreach (var manager in managers)
                        {
                            <option value="@manager.Id" data-name="@manager.FullName">@manager.FullName - @manager.Email</option>
                        }
                    }
                </select>
                <span asp-validation-for="ManagerId" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="form-check mb-3">
                <input asp-for="DisclosureAcknowledged" class="form-check-input" type="checkbox" id="disclosureCheck" />
                <label asp-for="DisclosureAcknowledged" class="form-check-label" for="disclosureCheck">
                    אני מאשר כי קראתי והבנתי את תנאי השימוש ומאשר את בקשת ההרשאה
                </label>
                <span asp-validation-for="DisclosureAcknowledged" class="text-danger d-block"></span>
            </div>
        </div>
    </div>

    <div class="form-group">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> שלח בקשה
        </button>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> ביטול
        </a>
    </div>
</form>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            // Employee search
            $('#employeeSearch').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('.employee-item').filter(function() {
                    $(this).toggle($(this).data('name').toLowerCase().indexOf(value) > -1);
                });
            });

            // Manager search
            $('#managerSearch').on('keyup', function() {
                var value = $(this).val().toLowerCase();
                $('#managerSelect option').each(function() {
                    var text = $(this).text().toLowerCase();
                    if (text.indexOf(value) > -1 || value === '') {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            // Form validation
            $('#requestForm').on('submit', function(e) {
                var hasEmployees = $('input[name="SelectedEmployeeIds"]:checked').length > 0;
                var hasSystems = $('input[name="SelectedSystemIds"]:checked').length > 0;
                var hasManager = $('#managerSelect').val() !== '';
                var hasDisclosure = $('#disclosureCheck').is(':checked');

                if (!hasEmployees) {
                    alert('אנא בחר לפחות עובד אחד');
                    e.preventDefault();
                    return false;
                }

                if (!hasSystems) {
                    alert('אנא בחר לפחות מערכת אחת');
                    e.preventDefault();
                    return false;
                }

                if (!hasManager) {
                    alert('אנא בחר מנהל אחראי');
                    e.preventDefault();
                    return false;
                }

                if (!hasDisclosure) {
                    alert('אנא אשר את גילוי הנאות');
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}

